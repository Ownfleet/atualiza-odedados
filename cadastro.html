<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regi√µes ‚Ä¢ OwnFleet</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root{
  --brand:#ee4d2d; --brand-2:#ff6b3d; --ink:#1f2937;
  --card:rgba(255,255,255,.92); --radius:20px;
  --shadow:0 18px 48px rgba(238,77,45,.25);
}
html,body{
  min-height:100%;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
  color:var(--ink);
}
h2{
  color:#fff;text-align:center;font-weight:900;margin:30px 0 20px;
  text-shadow:0 3px 8px rgba(0,0,0,.25);
}
.card{
  background:var(--card);backdrop-filter:blur(8px);
  border-radius:var(--radius);border:1px solid rgba(255,255,255,.5);
  box-shadow:var(--shadow);padding:24px;margin:auto;max-width:980px;
}
.badge-region{
  background:var(--brand);color:#fff;padding:.55rem .95rem;
  border-radius:999px;display:inline-flex;align-items:center;
  gap:.6rem;font-weight:700;margin:.3rem .3rem 0 0;
}
.badge-region i{cursor:pointer}
.sticky-submit{
  position:sticky;bottom:0;padding-top:.6rem;
  background:linear-gradient(180deg,rgba(255,255,255,0)0%,#fff 40%);
}
.small-dim{font-size:.9rem;color:#6b7280}
</style>
</head>

<body>
<h2>Cadastro de Regi√µes ‚Ä¢ OwnFleet</h2>

<div id="main-card" class="card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small-dim">Logado: <b id="whoami">-</b></div>
    <div class="d-flex gap-2">
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="fa fa-rotate"></i></button>
      <button id="logout" class="btn btn-sm btn-outline-danger"><i class="fa fa-power-off"></i> Sair</button>
    </div>
  </div>
  <hr>

  <div class="small-dim mb-2">
    Preencha seu <b>ID</b>, <b>Nome</b> e adicione as regi√µes que atende.
    Ap√≥s o primeiro envio, o <b>ID</b> fica bloqueado.
  </div>

  <form id="form-regioes" autocomplete="off">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">ID</label>
        <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
        <div class="small-dim mt-1">O ID √© salvo no primeiro envio e n√£o poder√° ser alterado.</div>
      </div>

      <div class="col-md-8">
        <label class="form-label">Nome</label>
        <input type="text" id="nome" class="form-control" required placeholder="Seu nome completo">
      </div>

      <div class="col-md-3">
        <label class="form-label">CEP</label>
        <input type="text" id="cep" class="form-control" maxlength="8" placeholder="Somente n√∫meros">
      </div>

      <div class="col-md-3">
        <label class="form-label">Regi√£o / Bairro</label>
        <input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar">
      </div>

      <div class="col-md-3">
        <label class="form-label">Cidade</label>
        <select id="cidadeAtual" class="form-select">
          <option selected>Guarulhos</option>
          <option>S√£o Paulo</option>
          <option>Mairipor√£</option>
          <option>Outros</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Ve√≠culo</label>
        <select id="veiculo" class="form-select">
          <option selected>Moto</option>
          <option>Passeio</option>
          <option>Fiorino</option>
          <option>Van</option>
        </select>
      </div>

      <div class="col-md-12 d-grid">
        <button type="button" class="btn btn-primary" id="add-regiao">
          <i class="fa fa-plus"></i> Adicionar Regi√£o (CEP + Bairro + Cidade)
        </button>
      </div>

      <div class="col-12">
        <div id="lista-regioes"></div>
        <small class="small-dim">
          M√°ximo de 20 entradas. Repetir <b>mesmo bairro</b> com <b>CEP diferente</b> √© permitido.
        </small>
      </div>

      <input type="hidden" id="regioes-consolidadas">
      <input type="hidden" id="ceps-consolidados">
      <input type="hidden" id="cidades-consolidadas">

      <div class="col-12 sticky-submit">
        <button type="submit" class="btn btn-success w-100">
          <i class="fa fa-paper-plane"></i> Enviar
        </button>
      </div>
    </div>
  </form>
</div>

<!-- üîπ SUPABASE -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ELEMENTOS
const whoami = document.getElementById("whoami");
const btnLogout = document.getElementById("logout");
const btnRefresh = document.getElementById("refresh");
const idInput = document.getElementById("id");
const nomeInput = document.getElementById("nome");
const cepInput = document.getElementById("cep");
const regiaoInput = document.getElementById("regiao");
const cidadeAtual = document.getElementById("cidadeAtual");
const veiculoSelect = document.getElementById("veiculo");
const addButton = document.getElementById("add-regiao");
const lista = document.getElementById("lista-regioes");
const form = document.getElementById("form-regioes");
const cepsConsolidados = document.getElementById("ceps-consolidados");
const regioesConsolidadas = document.getElementById("regioes-consolidadas");
const cidadesConsolidadas = document.getElementById("cidades-consolidadas");

let itens = [];
let currentUser = null;
let existingRow = null;

// Busca CEP ‚Üí Bairro
cepInput.addEventListener("input", () => {
  const cep = (cepInput.value || "").replace(/\D/g, "");
  if (cep.length === 8) {
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(r => r.json())
      .then(d => regiaoInput.value = d?.bairro?.toUpperCase() || "N√£o encontrado")
      .catch(() => regiaoInput.value = "Erro ao buscar");
  } else regiaoInput.value = "";
});

// Renderiza lista de regi√µes
function renderLista() {
  lista.innerHTML = "";
  itens.forEach((it, i) => {
    const s = document.createElement("span");
    s.className = "badge-region";
    s.innerHTML = `${it.bairro} <small>(${it.cep} ‚Ä¢ ${it.cidade})</small> <i class="fa fa-times" title="Remover" onclick="remover(${i})"></i>`;
    lista.appendChild(s);
  });
}
function updateHidden() {
  cepsConsolidados.value = itens.map(x => x.cep).join(",");
  regioesConsolidadas.value = itens.map(x => x.bairro).join(",");
  cidadesConsolidadas.value = itens.map(x => x.cidade).join(",");
}
window.remover = (idx) => { itens.splice(idx, 1); renderLista(); updateHidden(); };

// Adiciona regi√£o
addButton.addEventListener("click", () => {
  const cep = cepInput.value.trim();
  const bairro = regiaoInput.value.trim().toUpperCase();
  const cidade = cidadeAtual.value.trim();
  if (!cep || cep.length !== 8) return alert("Digite um CEP v√°lido (8 d√≠gitos).");
  if (!bairro) return alert("Busque o CEP para capturar a regi√£o/bairro.");
  if (itens.some(x => x.cep === cep && x.bairro === bairro)) return;
  if (itens.length >= 20) return alert("M√°ximo de 20 entradas.");

  itens.push({ cep, bairro, cidade });
  renderLista(); updateHidden();
  cepInput.value = ""; regiaoInput.value = "";
});

// Logout
btnLogout.onclick = async () => {
  await supabase.auth.signOut();
  window.location.replace("index.html");
};

// Atualizar dados
btnRefresh.onclick = ()=> carregarDoOwner();

// Sess√£o do usu√°rio
supabase.auth.onAuthStateChange(async (_evt, session) => {
  if (!session?.user) window.location.replace("index.html");
  else {
    currentUser = session.user;
    whoami.textContent = currentUser.email || currentUser.id;
    await carregarDoOwner();
  }
});

(async () => {
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user){ window.location.replace("index.html"); return; }
  currentUser = user;
  whoami.textContent = user.email || user.id;
  await carregarDoOwner();
})();

// Carregar dados do Supabase
async function carregarDoOwner() {
  existingRow = null; itens = []; renderLista(); updateHidden(); idInput.disabled = false;
  const { data, error } = await supabase.from("atualizar_bairros").select("*").eq("owner", currentUser.id).maybeSingle();
  if (data) {
    existingRow = data;
    idInput.value = data.driver_id || "";
    idInput.disabled = true;
    nomeInput.value = data.nome || "";
    veiculoSelect.value = data.veiculo || "Moto";
    const ceps = (data.ceps || "").split(",");
    const regioes = (data.regioes || "").split(",");
    const cidades = (data.cidades || "").split(",");
    for (let i = 0; i < ceps.length; i++) {
      if (ceps[i] && regioes[i]) itens.push({ cep: ceps[i], bairro: regioes[i], cidade: cidades[i] || "Guarulhos" });
    }
    renderLista(); updateHidden();
  }
}

// Envio
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (itens.length < 1) return alert("Adicione pelo menos 1 entrada.");
  const driver_id = idInput.value.trim();
  if (!driver_id) return alert("Informe seu ID.");

  const payload = {
    owner: currentUser.id,
    email: currentUser.email,
    driver_id,
    nome: nomeInput.value.trim(),
    ceps: cepsConsolidados.value,
    regioes: regioesConsolidadas.value,
    cidades: cidadesConsolidadas.value,
    veiculo: veiculoSelect.value,
    updated_at: new Date().toISOString()
  };

  const { error: upErr } = await supabase.from("atualizar_bairros").upsert(payload, { onConflict: "owner" });
  if (upErr) return alert("Erro ao salvar principal:\n" + upErr.message);

  const { error: logErr } = await supabase.from("atualizar_bairros_log").insert({ ...payload, created_at: payload.updated_at });
  if (logErr) return alert("Erro ao salvar log:\n" + logErr.message);

  alert("‚úÖ Dados salvos com sucesso!");
  await carregarDoOwner();
});
</script>
</body>
</html>
