<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regiões • OwnFleet</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --brand:#ee4d2d;
  --brand-2:#ff6b3d;
  --card:rgba(255,255,255,.95);
  --radius:22px;
  --shadow:0 18px 48px rgba(238,77,45,.25);
}
body {
  background:linear-gradient(145deg,var(--brand),var(--brand-2));
  min-height:100vh;margin:0;
  display:flex;align-items:center;justify-content:center;
  font-family:'Poppins',system-ui,sans-serif;overflow:hidden;
}
.modal-dialog{max-width:420px;width:100%}
.modal-content{
  background:var(--card);
  border-radius:var(--radius);
  border:none;
  box-shadow:var(--shadow);
  backdrop-filter:blur(14px);
  padding:1rem 1.5rem;
}
.modal-header{border:none;flex-direction:column;align-items:center}
.modal-title{
  font-weight:800;font-size:1.4rem;
  color:var(--brand);text-align:center;
}
#avatarImg{
  width:58px;height:58px;border-radius:50%;
  object-fit:cover;margin-bottom:6px;
  border:3px solid rgba(255,255,255,.6);
  box-shadow:0 0 12px rgba(0,0,0,.15);
  display:none;
}
#whoami{color:#555;font-size:.9rem}
label{font-weight:500}
.btn-primary{background:var(--brand);border:none;transition:.3s}
.btn-primary:hover{background:var(--brand-2);transform:scale(1.03)}
.btn-success{background:#059669;border:none;transition:.3s}
.btn-success:disabled{opacity:.8}
.btn-success:hover:not(:disabled){transform:scale(1.02)}
.badge-region{
  display:inline-flex;align-items:center;gap:.5rem;
  background:var(--brand);color:#fff;border-radius:999px;
  padding:.5rem .9rem;font-weight:600;font-size:.85rem;
  margin:.3rem .3rem 0 0;
}
.badge-region i{cursor:pointer;opacity:.8}
.badge-region i:hover{opacity:1}
.toast{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%);
  background:#16a34a;color:white;
  padding:14px 24px;border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.2);
  font-weight:500;display:none;
  animation:fadein .3s ease-out;
}
@keyframes fadein{
  from{opacity:0;transform:translate(-50%,20px)}
  to{opacity:1;transform:translate(-50%,0)}
}
.spinner{
  width:18px;height:18px;
  border:3px solid rgba(255,255,255,.4);
  border-top-color:white;
  border-radius:50%;
  animation:spin .8s linear infinite;
  display:inline-block;vertical-align:middle;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<!-- Modal Principal -->
<div class="modal fade show" style="display:block;background:rgba(0,0,0,.4);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <img id="avatarImg" src="" alt="Avatar">
        <h5 class="modal-title"><i class="fa-solid fa-map-location-dot me-2"></i>Cadastro de Regiões</h5>
        <small id="whoami">Carregando...</small>
      </div>
      <div class="modal-body">
        <form id="form-regioes" autocomplete="off">
          <div class="mb-3">
            <label>ID</label>
            <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
          </div>
          <div class="mb-3">
            <label>Nome</label>
            <input type="text" id="nome" class="form-control" placeholder="Seu nome completo" required>
          </div>
          <div class="mb-3">
            <label>CEP</label>
            <input type="text" id="cep" maxlength="8" class="form-control" placeholder="Somente números">
          </div>
          <div class="mb-3">
            <label>Região / Bairro</label>
            <input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar">
          </div>
          <!-- Botão Adicionar Região -->
          <div class="d-grid mb-3">
            <button type="button" id="add-regiao" class="btn btn-primary">
              <i class="fa fa-plus"></i> Adicionar Região
            </button>
          </div>
          <div id="lista-regioes" class="mb-3"></div>

          <div class="mb-3">
            <label>Cidade</label>
            <select id="cidadeAtual" class="form-select">
              <option selected>Guarulhos</option>
              <option>São Paulo</option>
              <option>Mairiporã</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Veículo</label>
            <select id="veiculo" class="form-select">
              <option selected>Moto</option>
              <option>Fiorino</option>
              <option>Carro</option>
              <option>Van</option>
            </select>
          </div>
          <div class="d-grid mt-4">
            <button type="submit" id="btnEnviar" class="btn btn-success">
              <i class="fa fa-paper-plane"></i> Enviar
            </button>
          </div>
          <div class="text-center mt-3">
            <button id="logout" type="button" class="btn btn-sm btn-outline-danger px-3">
              <i class="fa fa-power-off"></i> Sair
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">✅ Dados salvos com sucesso!</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://bzbkqvxixxkcmfrhtcxq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE");

const whoami = document.getElementById("whoami");
const avatarImg = document.getElementById("avatarImg");
const idInput = document.getElementById("id");
const nomeInput = document.getElementById("nome");
const cepInput = document.getElementById("cep");
const regiaoInput = document.getElementById("regiao");
const cidadeAtual = document.getElementById("cidadeAtual");
const veiculoSelect = document.getElementById("veiculo");
const addButton = document.getElementById("add-regiao");
const lista = document.getElementById("lista-regioes");
const form = document.getElementById("form-regioes");
const btnEnviar = document.getElementById("btnEnviar");
const logout = document.getElementById("logout");
const toast = document.getElementById("toast");

let itens = [], user = null;

function showToast(msg, cor="#16a34a"){
  toast.textContent = msg;
  toast.style.background = cor;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none",2500);
}
function setLoading(loading){
  if(loading){
    btnEnviar.innerHTML='<span class="spinner"></span> Enviando...';
    btnEnviar.disabled=true;
  }else{
    btnEnviar.innerHTML='<i class="fa fa-paper-plane"></i> Enviar';
    btnEnviar.disabled=false;
  }
}
function render(){
  lista.innerHTML="";
  itens.forEach((x,i)=>{
    const s=document.createElement("span");
    s.className="badge-region";
    s.innerHTML=`${x.bairro} (${x.cep} • ${x.cidade}) <i class="fa fa-times" onclick="remover(${i})"></i>`;
    lista.appendChild(s);
  });
}
window.remover=(i)=>{itens.splice(i,1);render();};

// Busca CEP
cepInput.addEventListener("input",()=>{
  const cep=cepInput.value.replace(/\D/g,"");
  if(cep.length===8){
    fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r=>r.json()).then(d=>{
      regiaoInput.value=d.bairro||"Não encontrado";
    });
  }
});

// Adicionar região
addButton.onclick=()=>{
  const cep=cepInput.value.trim(),bairro=regiaoInput.value.trim().toUpperCase(),cidade=cidadeAtual.value;
  if(!cep||cep.length!==8||!bairro)return showToast("CEP inválido ou bairro não encontrado.","#dc2626");
  if(itens.length>=20)return showToast("Máximo de 20 regiões.","#dc2626");
  itens.push({cep,bairro,cidade});
  cepInput.value="";regiaoInput.value="";render();
};

// Avatar automático
function setAvatarFromUser(u){
  const url=u?.user_metadata?.avatar_url||u?.user_metadata?.picture||u?.identities?.[0]?.identity_data?.avatar_url||u?.identities?.[0]?.identity_data?.picture;
  if(url){avatarImg.src=url;avatarImg.style.display="block";}
}

// Login check
supabase.auth.onAuthStateChange(async(_,session)=>{
  if(!session?.user)return window.location.href="index.html";
  user=session.user;
  whoami.textContent=user.email;
  setAvatarFromUser(user);
  carregar();
});
(async()=>{
  const {data:{user:u}}=await supabase.auth.getUser();
  if(!u)return window.location.href="index.html";
  user=u;whoami.textContent=u.email;
  setAvatarFromUser(u);
  carregar();
})();

async function carregar(){
  const {data}=await supabase.from("atualizar_bairros").select("*").eq("owner",user.id).maybeSingle();
  if(data){
    idInput.value=data.driver_id;idInput.disabled=true;
    nomeInput.value=data.nome;veiculoSelect.value=data.veiculo;
    const ceps=(data.ceps||"").split(","),regs=(data.regioes||"").split(","),cids=(data.cidades||"").split(",");
    itens=[];for(let i=0;i<ceps.length;i++)itens.push({cep:ceps[i],bairro:regs[i],cidade:cids[i]});
    render();
  }
}

// Enviar (mínimo 4 CEPs)
form.addEventListener("submit",async(e)=>{
  e.preventDefault();
  if(itens.length<4)return showToast("Adicione pelo menos 4 regiões","#dc2626");
  setLoading(true);
  const payload={
    owner:user.id,email:user.email,driver_id:idInput.value.trim(),nome:nomeInput.value.trim(),
    ceps:itens.map(x=>x.cep).join(","),regioes:itens.map(x=>x.bairro).join(","),cidades:itens.map(x=>x.cidade).join(","),
    veiculo:veiculoSelect.value,updated_at:new Date().toISOString()
  };
  const {error}=await supabase.from("atualizar_bairros").upsert(payload,{onConflict:"owner"});
  if(error){setLoading(false);return showToast("Erro ao salvar","#dc2626");}
  await supabase.from("atualizar_bairros_log").insert(payload);
  setLoading(false);
  showToast("✅ Dados salvos com sucesso!");
});

logout.onclick=async()=>{await supabase.auth.signOut();window.location.href="index.html";};
</script>
</body>
</html>
