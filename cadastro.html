<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regi√µes ‚Ä¢ OwnFleet</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --brand:#ee4d2d;
  --brand-2:#ff6b3d;
  --card:rgba(255,255,255,.95);
  --radius:22px;
  --shadow:0 18px 48px rgba(238,77,45,.25);
}
body {
  background:linear-gradient(145deg,var(--brand),var(--brand-2));
  min-height:100vh;margin:0;
  display:flex;align-items:center;justify-content:center;
  font-family:'Poppins',system-ui,sans-serif;overflow:hidden;
}
.modal-dialog{max-width:420px;width:100%}
.modal-content{
  background:var(--card);
  border-radius:var(--radius);
  border:none;
  box-shadow:var(--shadow);
  backdrop-filter:blur(14px);
  padding:1rem 1.5rem;
}
.modal-header{border:none;flex-direction:column;align-items:center}
.modal-title{
  font-weight:800;font-size:1.4rem;
  color:var(--brand);text-align:center;
}
#avatarImg{
  width:58px;height:58px;border-radius:50%;
  object-fit:cover;margin-bottom:6px;
  border:3px solid rgba(255,255,255,.6);
  box-shadow:0 0 12px rgba(0,0,0,.15);
  display:none;
}
#whoami{color:#555;font-size:.9rem}
label{font-weight:500}
.btn-primary{background:var(--brand);border:none;transition:.3s}
.btn-primary:hover{background:var(--brand-2);transform:scale(1.03)}
.btn-success{background:#059669;border:none;transition:.3s}
.btn-success:disabled{opacity:.8}
.btn-success:hover:not(:disabled){transform:scale(1.02)}
.badge-region{
  display:inline-flex;align-items:center;gap:.5rem;
  background:var(--brand);color:#fff;border-radius:999px;
  padding:.5rem .9rem;font-weight:600;font-size:.85rem;
  margin:.3rem .3rem 0 0;
}
.badge-region i{cursor:pointer;opacity:.8}
.badge-region i:hover{opacity:1}

/* üî∂ Toast Shopee (banner no topo) */
.toast-top {
  position: fixed;
  top: 16px; left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #fff;
  padding: 12px 18px;
  border-radius: 999px;
  box-shadow: 0 12px 30px rgba(0,0,0,.18);
  font-weight: 700;
  display: none;
  z-index: 9999;
  letter-spacing: .2px;
}
.toast-top.show {
  display: block;
  animation: slideDown .32s ease-out, fadeOut .3s ease-out 2.4s forwards;
}
@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0);     opacity: 1; }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translateX(-50%) translateY(-12px); }
}

.spinner{
  width:18px;height:18px;
  border:3px solid rgba(255,255,255,.4);
  border-top-color:white;
  border-radius:50%;
  animation:spin .8s linear infinite;
  display:inline-block;vertical-align:middle;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<!-- Modal Principal -->
<div class="modal fade show" style="display:block;background:rgba(0,0,0,.4);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <img id="avatarImg" src="" alt="Avatar">
        <h5 class="modal-title"><i class="fa-solid fa-map-location-dot me-2"></i>Cadastro de Regi√µes</h5>
        <small id="whoami">Carregando...</small>
      </div>
      <div class="modal-body">
        <form id="form-regioes" autocomplete="off">
          <div class="mb-3">
            <label>ID</label>
            <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
          </div>
          <div class="mb-3">
            <label>Nome</label>
            <input type="text" id="nome" class="form-control" placeholder="Seu nome completo" required>
          </div>
          <div class="mb-3">
            <label>CEP</label>
            <input type="text" id="cep" maxlength="8" class="form-control" placeholder="Somente n√∫meros">
          </div>
          <div class="mb-3">
            <label>Regi√£o / Bairro</label>
            <input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar">
          </div>
          <!-- Bot√£o Adicionar Regi√£o -->
          <div class="d-grid mb-3">
            <button type="button" id="add-regiao" class="btn btn-primary">
              <i class="fa fa-plus"></i> Adicionar Regi√£o
            </button>
          </div>
          <div id="lista-regioes" class="mb-3"></div>

          <div class="mb-3">
            <label>Cidade</label>
            <select id="cidadeAtual" class="form-select">
              <option selected>Guarulhos</option>
              <option>S√£o Paulo</option>
              <option>Mairipor√£</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Ve√≠culo</label>
            <select id="veiculo" class="form-select">
              <option selected>Moto</option>
              <option>Fiorino</option>
              <option>Carro</option>
              <option>Van</option>
            </select>
          </div>
          <div class="d-grid mt-4">
            <button type="submit" id="btnEnviar" class="btn btn-success">
              <i class="fa fa-paper-plane"></i> Enviar
            </button>
          </div>
          <div class="text-center mt-3">
            <button id="logout" type="button" class="btn btn-sm btn-outline-danger px-3">
              <i class="fa fa-power-off"></i> Sair
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- üî∂ Banner de confirma√ß√£o -->
<div class="toast-top" id="toastTop"><i class="fa-solid fa-circle-check me-2"></i><span id="toastMsg">OK</span></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(
  "https://bzbkqvxixxkcmfrhtcxq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE"
);

const whoami = document.getElementById("whoami");
const avatarImg = document.getElementById("avatarImg");
const idInput = document.getElementById("id");
const nomeInput = document.getElementById("nome");
const cepInput = document.getElementById("cep");
const regiaoInput = document.getElementById("regiao");
const cidadeAtual = document.getElementById("cidadeAtual");
const veiculoSelect = document.getElementById("veiculo");
const addButton = document.getElementById("add-regiao");
const lista = document.getElementById("lista-regioes");
const form = document.getElementById("form-regioes");
const btnEnviar = document.getElementById("btnEnviar");
const logout = document.getElementById("logout");

const toastTop = document.getElementById("toastTop");
const toastMsg = document.getElementById("toastMsg");

let itens = [], user = null, jaExiste = false;

/* üî∂ Toast Shopee (banner topo) */
function showToast(msg){
  toastMsg.textContent = msg;
  toastTop.classList.remove("show");
  void toastTop.offsetWidth; // reflow pra reiniciar anima√ß√£o
  toastTop.classList.add("show");
}

/* Loading no bot√£o */
function setLoading(on){
  if(on){
    btnEnviar.innerHTML = '<span class="spinner"></span> Salvando...';
    btnEnviar.disabled = true;
  } else {
    btnEnviar.innerHTML = jaExiste
      ? '<i class="fa fa-save"></i> Atualizar'
      : '<i class="fa fa-paper-plane"></i> Enviar';
    btnEnviar.disabled = false;
  }
}

function render(){
  lista.innerHTML = "";
  itens.forEach((x,i)=>{
    const tag = document.createElement("span");
    tag.className="badge-region";
    tag.innerHTML = `${x.bairro} (${x.cep} ‚Ä¢ ${x.cidade}) <i class="fa fa-times" onclick="remover(${i})"></i>`;
    lista.appendChild(tag);
  });
}
window.remover = (i)=>{ itens.splice(i,1); render(); };

/* ViaCEP */
cepInput.addEventListener("input", ()=>{
  const cep = cepInput.value.replace(/\D/g,"");
  if(cep.length === 8){
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(r=>r.json())
      .then(d=> regiaoInput.value = d.bairro || "N√£o encontrado")
      .catch(()=> regiaoInput.value = "N√£o encontrado");
  }
});

/* ‚úÖ Adicionar regi√£o ‚Äî CEP √∫nico, regi√£o pode repetir (ATUALIZADO) */
addButton.onclick = ()=>{
  const cep = cepInput.value.trim();
  const cepNorm = cep.replace(/\D/g,'');     // normaliza s√≥ n√∫meros
  const bairro = regiaoInput.value.trim().toUpperCase();
  const cidade = cidadeAtual.value;

  if(!cepNorm || cepNorm.length !== 8 || !bairro){
    showToast("CEP inv√°lido ou bairro n√£o encontrado");
    return;
  }

  // Bloqueia CEP repetido (independente da regi√£o ou cidade)
  if(itens.some(x => x.cep.replace(/\D/g,'') === cepNorm)){
    showToast("Este CEP j√° foi adicionado");
    return;
  }

  if(itens.length >= 20){
    showToast("Limite m√°ximo: 20 regi√µes");
    return;
  }

  // Regi√£o/bairro pode repetir; CEP √© que deve ser √∫nico
  itens.push({ cep: cepNorm, bairro, cidade });

  cepInput.value = "";
  regiaoInput.value = "";
  render();
};

/* Avatar */
function setAvatarFromUser(u){
  const url = u?.user_metadata?.avatar_url || u?.user_metadata?.picture ||
              u?.identities?.[0]?.identity_data?.avatar_url || u?.identities?.[0]?.identity_data?.picture;
  if(url){ avatarImg.src = url; avatarImg.style.display = "block"; }
}

/* Auth */
supabase.auth.onAuthStateChange(async(_,session)=>{
  if(!session?.user) return location.href="index.html";
  user = session.user;
  whoami.textContent = user.email;
  setAvatarFromUser(user);
  carregar();
});
(async()=>{
  const {data:{user:u}} = await supabase.auth.getUser();
  if(!u) return location.href="index.html";
  user=u; whoami.textContent=u.email; setAvatarFromUser(u); carregar();
})();

/* Carregar dados existentes */
async function carregar(){
  const {data, error} = await supabase
    .from("atualizar_bairros")
    .select("*")
    .eq("owner", user.id)
    .maybeSingle();

  if(error){ console.warn("Carregar erro:", error); }

  if(data){
    jaExiste = true;
    idInput.value = data.driver_id;
    idInput.disabled = true;
    nomeInput.value = data.nome || "";
    veiculoSelect.value = data.veiculo || "Moto";

    const ceps = (data.ceps||"").split(",").map(s=>s.trim()).filter(Boolean);
    const regs = (data.regioes||"").split(",").map(s=>s.trim());
    const cids = (data.cidades||"").split(",").map(s=>s.trim());
    itens = [];
    for(let i=0;i<ceps.length;i++){
      itens.push({ cep: ceps[i], bairro: (regs[i]||"").toUpperCase(), cidade: cids[i]||"" });
    }
    render();

    btnEnviar.innerHTML = '<i class="fa fa-save"></i> Atualizar';
  }
}

/* Enviar / Atualizar (mostra confirma√ß√£o visual) */
form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(itens.length < 4){
    showToast("Adicione pelo menos 4 regi√µes");
    return;
  }

  setLoading(true);
  const payload = {
    owner: user.id,
    email: user.email,
    driver_id: idInput.value.trim(),
    nome: nomeInput.value.trim(),
    ceps: itens.map(x=>x.cep).join(","),
    regioes: itens.map(x=>x.bairro).join(","),
    cidades: itens.map(x=>x.cidade).join(","),
    veiculo: veiculoSelect.value,
    updated_at: new Date().toISOString()
  };

  // trava ID ap√≥s 1¬™ grava√ß√£o
  if(jaExiste){
    const { data: existente } = await supabase
      .from("atualizar_bairros")
      .select("driver_id")
      .eq("owner", user.id)
      .maybeSingle();
    if(existente?.driver_id){
      payload.driver_id = existente.driver_id;
      idInput.value = existente.driver_id;
      idInput.disabled = true;
    }
  }

  const { error } = await supabase
    .from("atualizar_bairros")
    .upsert(payload, { onConflict: "owner" });

  if(error){
    setLoading(false);
    showToast("Erro ao salvar");
    console.error(error);
    return;
  }

  // log de mudan√ßa
  await supabase.from("atualizar_bairros_log").insert(payload);

  setLoading(false);
  showToast(jaExiste ? "Dados atualizados com sucesso!" : "Cadastro realizado com sucesso!");

  jaExiste = true;
  btnEnviar.innerHTML = '<i class="fa fa-save"></i> Atualizar';
});

/* Logout */
logout.onclick = async()=>{
  await supabase.auth.signOut();
  location.href = "index.html";
};
</script>
</body>
</html>
