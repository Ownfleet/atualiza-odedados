<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regiões • OwnFleet</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root{--brand:#ee4d2d;--brand-2:#ff6b3d;--ink:#1f2937;--card:rgba(255,255,255,.92);--radius:20px;--shadow:0 18px 48px rgba(238,77,45,.25)}
html,body{min-height:100%;background:linear-gradient(135deg,var(--brand),var(--brand-2));font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;color:var(--ink);margin:0}
h2{color:#fff;text-align:center;font-weight:900;margin:30px 0 20px;text-shadow:0 3px 8px rgba(0,0,0,.25)}
.card{background:var(--card);backdrop-filter:blur(8px);border-radius:var(--radius);border:1px solid rgba(255,255,255,.5);box-shadow:var(--shadow);padding:24px;margin:auto;max-width:980px}
.badge-region{background:var(--brand);color:#fff;padding:.55rem .95rem;border-radius:999px;display:inline-flex;align-items:center;gap:.6rem;font-weight:700;margin:.3rem .3rem 0 0}
.badge-region i{cursor:pointer}
.sticky-submit{position:sticky;bottom:0;padding-top:.6rem;background:linear-gradient(180deg,rgba(255,255,255,0)0%,#fff 40%)}
.small-dim{font-size:.9rem;color:#6b7280}
.err{color:#b00020;margin-top:8px;white-space:pre-wrap}
</style>
</head>
<body>
  <h2>Cadastro de Regiões • OwnFleet</h2>

  <div id="main-card" class="card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="small-dim">Logado: <b id="whoami">-</b></div>
      <div class="d-flex gap-2">
        <button id="refresh" class="btn btn-sm btn-outline-secondary" title="Recarregar meus dados"><i class="fa fa-rotate"></i></button>
        <button id="logout" class="btn btn-sm btn-outline-danger" title="Sair"><i class="fa fa-power-off"></i> Sair</button>
      </div>
    </div>
    <div id="msg" class="err" style="display:none"></div>
    <hr>

    <div class="small-dim mb-2">
      Preencha seu <b>ID</b>, <b>Nome</b> e adicione as regiões que atende. Após o primeiro envio, o <b>ID</b> fica bloqueado.
    </div>

    <form id="form-regioes" autocomplete="off">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">ID</label>
          <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
          <div class="small-dim mt-1">O ID é salvo no primeiro envio e não poderá ser alterado.</div>
        </div>
        <div class="col-md-8">
          <label class="form-label">Nome</label>
          <input type="text" id="nome" class="form-control" required placeholder="Seu nome completo">
        </div>

        <!-- CEP -->
        <div class="col-12 col-sm-6 col-md-4">
          <label class="form-label">CEP</label>
          <input type="text" id="cep" class="form-control" maxlength="8" placeholder="Somente números">
        </div>

        <!-- Região + Botão (empilha no mobile, lado a lado no desktop) -->
        <div class="col-12 col-sm-6 col-md-4">
          <label class="form-label">Região / Bairro</label>
          <div class="d-flex flex-column flex-md-row gap-2">
            <input type="text" id="regiao" class="form-control flex-grow-1" readonly placeholder="Preencha o CEP para buscar">
            <button type="button" class="btn btn-primary mt-2 mt-md-0" id="add-regiao">
              <i class="fa fa-plus"></i> Adicionar Região
            </button>
          </div>
        </div>

        <!-- Cidade -->
        <div class="col-12 col-md-4">
          <label class="form-label">Cidade</label>
          <select id="cidadeAtual" class="form-select">
            <option selected>Guarulhos</option>
            <option>São Paulo</option>
            <option>Mairiporã</option>
            <option>Outros</option>
          </select>
        </div>

        <!-- Veículo -->
        <div class="col-12 col-md-4">
          <label class="form-label">Veículo</label>
          <select id="veiculo" class="form-select">
            <option selected>Moto</option>
            <option>Passeio</option>
            <option>Fiorino</option>
            <option>Van</option>
          </select>
        </div>

        <div class="col-12">
          <div id="lista-regioes"></div>
          <small class="small-dim">Máximo de 20 entradas. Repetir <b>mesmo bairro</b> com <b>CEP diferente</b> é permitido.</small>
        </div>

        <!-- consolidação -->
        <input type="hidden" id="regioes-consolidadas">
        <input type="hidden" id="ceps-consolidados">
        <input type="hidden" id="cidades-consolidadas">

        <div class="col-12 sticky-submit">
          <button type="submit" id="btn-enviar" class="btn btn-success w-100">
            <i class="fa fa-paper-plane"></i> Enviar
          </button>
        </div>
      </div>
    </form>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// === SUPABASE DO SEU PROJETO ===
const SUPABASE_URL = "https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";

// melhora multi-aba e refresh de token
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

function baseUrl(){
  const {origin,pathname}=location;
  const dir = pathname.endsWith("/") ? pathname : pathname.replace(/[^/]*$/,"");
  return origin + dir;
}

// === ELEMENTOS ===
const whoami = document.getElementById("whoami");
const btnLogout = document.getElementById("logout");
const btnRefresh = document.getElementById("refresh");
const idInput = document.getElementById("id");
const nomeInput = document.getElementById("nome");
const cepInput = document.getElementById("cep");
const regiaoInput = document.getElementById("regiao");
const cidadeAtual = document.getElementById("cidadeAtual");
const veiculoSelect = document.getElementById("veiculo");
const addButton = document.getElementById("add-regiao");
const lista = document.getElementById("lista-regioes");
const form = document.getElementById("form-regioes");
const cepsConsolidados = document.getElementById("ceps-consolidados");
const regioesConsolidadas = document.getElementById("regioes-consolidadas");
const cidadesConsolidadas = document.getElementById("cidades-consolidadas");
const msg = document.getElementById("msg");
const btnEnviar = document.getElementById("btn-enviar");

// === ESTADO ===
let itens = [];         // { cep, bairro, cidade }
let currentUser = null; // sessão
let existingRow = null; // snapshot existente
let isLoggingOut = false;

// --- utils
const csvToArray = (csv) => csv ? csv.split(",").map(s => s.trim()).filter(Boolean) : [];
const arrToCsv   = (arr) => (arr || []).join(",");
function setError(e){ msg.style.display="block"; msg.textContent = typeof e === "string" ? e : (e?.message || JSON.stringify(e)); }
function clearError(){ msg.style.display="none"; msg.textContent=""; }

// === CEP -> BAIRRO (ViaCEP com fallback BrasilAPI)
cepInput.addEventListener("input", async () => {
  const cep = (cepInput.value || "").replace(/\D/g, "");
  if (cep.length !== 8) { regiaoInput.value = ""; return; }

  const url1 = `https://viacep.com.br/ws/${cep}/json/`;
  const url2 = `https://brasilapi.com.br/api/cep/v2/${cep}`;
  try {
    let r = await fetch(url1);
    if (!r.ok) r = await fetch(url2);
    const d = await r.json();
    regiaoInput.value = (d?.bairro || d?.neighborhood || "").toString() || "Não encontrado";
  } catch(e) {
    console.warn("Erro ao buscar CEP:", e?.message || e);
    regiaoInput.value = ""; // não trava o fluxo
  }
});

// === LISTA REGIÕES
function renderLista(){
  lista.innerHTML = "";
  itens.forEach((it, i) => {
    const s = document.createElement("span");
    s.className = "badge-region";
    s.innerHTML = `${it.bairro} <small>(${it.cep} • ${it.cidade})</small> <i class="fa fa-times" title="Remover" onclick="remover(${i})"></i>`;
    lista.appendChild(s);
  });
}
function updateHidden(){
  cepsConsolidados.value    = arrToCsv(itens.map(x => x.cep));
  regioesConsolidadas.value = arrToCsv(itens.map(x => x.bairro));
  cidadesConsolidadas.value = arrToCsv(itens.map(x => x.cidade));
}
window.remover = (idx) => { itens.splice(idx,1); renderLista(); updateHidden(); };

addButton.addEventListener("click", () => {
  const cep    = (cepInput.value || "").replace(/\D/g, "");
  const bairro = (regiaoInput.value || "").trim().toUpperCase();
  const cidade = (cidadeAtual.value || "").trim();
  if (!cep || cep.length !== 8) return alert("Digite um CEP válido (8 dígitos).");
  if (!bairro) return alert("Busque o CEP para capturar a região/bairro.");
  if (itens.some(x => x.cep === cep && x.bairro === bairro && x.cidade === cidade)) return;
  if (itens.length >= 20) return alert("Máximo de 20 entradas.");

  itens.push({ cep, bairro, cidade });
  renderLista(); updateHidden();
  cepInput.value = ""; regiaoInput.value = "";
});

// === LOGOUT
btnLogout.onclick = async () => {
  if (isLoggingOut) return;
  isLoggingOut = true;
  try { await supabase.auth.signOut(); } catch(_) {}
  window.location.replace(baseUrl() + "index.html");
};

// === REFRESH manual
btnRefresh.onclick = ()=> carregarDoOwner();

// === SESSÃO / AUTH
supabase.auth.onAuthStateChange(async (_event, session)=>{
  if (!session?.user && !isLoggingOut) {
    window.location.replace(baseUrl() + "index.html");
    return;
  }
  if (session?.user) {
    currentUser = session.user;
    whoami.textContent = currentUser.email || currentUser.id;
    await carregarDoOwner();
  }
});

// boot inicial (funciona em multi-aba)
(async ()=>{
  try{
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session?.user) {
      window.location.replace(baseUrl() + "index.html");
      return;
    }
    currentUser = session.user;
    whoami.textContent = currentUser.email || currentUser.id;
    await carregarDoOwner();
  }catch(e){
    setError(e);
  }
})();

// === CARREGAR snapshot por owner
async function carregarDoOwner(){
  clearError();
  existingRow=null; itens=[]; renderLista(); updateHidden(); idInput.disabled=false;

  const { data, error } = await supabase
    .from("atualizar_bairros")
    .select("*")
    .eq("owner", currentUser.id)
    .maybeSingle();

  if (error) { setError(error); return; }
  if (data){
    existingRow = data;
    idInput.value = data.driver_id || "";
    idInput.disabled = true; // trava ID após 1º envio
    nomeInput.value = data.nome || "";
    veiculoSelect.value = data.veiculo || "Moto";

    const arrCeps    = csvToArray(data.ceps);
    const arrBairros = csvToArray(data.regioes);
    const arrCidades = csvToArray(data.cidades);

    const n = Math.max(arrCeps.length, arrBairros.length, arrCidades.length);
    for (let i=0;i<n;i++){
      const cep = (arrCeps[i]||"").trim();
      const bairro = (arrBairros[i]||"").trim().toUpperCase();
      const cidade = (arrCidades[i]||"").trim() || "Guarulhos";
      if (cep && bairro) itens.push({ cep, bairro, cidade });
    }
    renderLista(); updateHidden();
  }
}

// === SUBMIT (UPSERT + LOG) — com auto-adicionar se esquecer de clicar "Adicionar Região"
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearError();
  btnEnviar.disabled = true;

  try {
    // auto-adiciona 1 item se o user preencheu os campos mas esqueceu de clicar "Adicionar"
    const cepField    = (cepInput.value || "").replace(/\D/g, "");
    const bairroField = (regiaoInput.value || "").trim().toUpperCase();
    const cidadeField = (cidadeAtual.value || "").trim();
    if (itens.length === 0 && cepField.length === 8 && bairroField) {
      itens.push({ cep: cepField, bairro: bairroField, cidade: cidadeField || "Guarulhos" });
      renderLista(); updateHidden();
    }

    if (itens.length < 1) { alert("Adicione pelo menos 1 entrada (CEP + Bairro)."); return; }

    const driver_id = (idInput.value || "").trim();
    if (!existingRow && !driver_id) { alert("Informe seu ID (primeiro cadastro)."); return; }

    const payload = {
      owner: currentUser.id,
      email: currentUser.email || null,
      driver_id: existingRow ? existingRow.driver_id : driver_id,
      nome: (nomeInput.value || "").trim(),
      ceps: (cepsConsolidados.value || "").trim(),
      regioes: (regioesConsolidadas.value || "").trim(),
      cidades: (cidadesConsolidadas.value || "").trim(),
      veiculo: (veiculoSelect.value || "").trim(),
      updated_at: new Date().toISOString()
    };

    // snapshot (1 por owner)
    const { error: upErr } = await supabase
      .from("atualizar_bairros")
      .upsert(payload, { onConflict: "owner" });
    if (upErr) {
      console.error("Upsert atualizar_bairros ERROR:", upErr);
      throw upErr;
    }

    // log (1 por envio) — sem travar se falhar
    const { error: logErr } = await supabase.from("atualizar_bairros_log").insert({
      owner: payload.owner,
      email: payload.email,
      driver_id: payload.driver_id,
      nome: payload.nome,
      ceps: payload.ceps,
      regioes: payload.regioes,
      cidades: payload.cidades,
      veiculo: payload.veiculo,
      created_at: payload.updated_at
    });
    if (logErr) console.warn("Insert log WARNING:", logErr);

    alert("Dados salvos com sucesso!");
    await carregarDoOwner();
  } catch(err){
    console.error("SUBMIT exception:", err);
    const emsg = err?.message || JSON.stringify(err);
    if (/row-level security/i.test(emsg)) {
      setError("Erro de permissão (RLS). Ajuste as policies para permitir INSERT/UPDATE quando owner = auth.uid().");
    } else if (/on conflict/i.test(emsg) && /owner/i.test(emsg)) {
      setError("Crie a UNIQUE (owner) na tabela 'atualizar_bairros' para o upsert funcionar.");
    } else {
      setError("Erro ao salvar: " + emsg);
    }
  } finally {
    btnEnviar.disabled = false;
  }
});
</script>
</body>
</html>
