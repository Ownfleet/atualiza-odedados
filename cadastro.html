<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regiões • OwnFleet</title>

<!-- Bootstrap e FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --brand: #ee4d2d;
  --brand-2: #ff6b3d;
  --bg: #fff7f5;
  --card: rgba(255,255,255,.95);
  --shadow: 0 18px 48px rgba(238,77,45,.25);
}
body {
  background: linear-gradient(145deg, var(--brand), var(--brand-2));
  min-height: 100vh;
  font-family: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
  display: flex; align-items: center; justify-content: center;
  margin: 0; padding: 0;
}
.modal-content {
  border-radius: 20px;
  box-shadow: var(--shadow);
  background: var(--card);
  backdrop-filter: blur(12px);
  border: none;
}
h5.modal-title {
  color: var(--brand);
  font-weight: 800;
}
.btn-primary {
  background: var(--brand);
  border: none;
}
.btn-primary:hover { background: var(--brand-2); }
.badge-region {
  background: var(--brand);
  color: #fff;
  padding: .55rem .95rem;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  font-weight: 600;
  margin: .3rem .3rem 0 0;
}
.badge-region i { cursor: pointer; }
.small-dim { font-size: .9rem; color: #6b7280; }
</style>
</head>

<body>
<!-- Modal Principal -->
<div class="modal fade show" id="cadastroModal" tabindex="-1" style="display:block;background:rgba(0,0,0,.45);">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-map-location-dot me-2"></i>Cadastro de Regiões</h5>
        <button id="logout" class="btn btn-sm btn-outline-danger"><i class="fa fa-power-off"></i></button>
      </div>

      <div class="modal-body">
        <div class="small-dim mb-3">
          Logado como <b id="whoami">-</b>
        </div>

        <form id="form-regioes" autocomplete="off">
          <div class="mb-3">
            <label class="form-label">ID</label>
            <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
            <div class="small-dim">O ID é salvo no primeiro envio e não poderá ser alterado.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" id="nome" class="form-control" required placeholder="Seu nome completo">
          </div>

          <div class="mb-3">
            <label class="form-label">CEP</label>
            <input type="text" id="cep" class="form-control" maxlength="8" placeholder="Somente números">
          </div>

          <div class="mb-3">
            <label class="form-label">Região / Bairro</label>
            <input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar">
          </div>

          <div class="mb-3">
            <label class="form-label">Cidade</label>
            <select id="cidadeAtual" class="form-select">
              <option selected>Guarulhos</option>
              <option>São Paulo</option>
              <option>Mairiporã</option>
              <option>Outros</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Veículo</label>
            <select id="veiculo" class="form-select">
              <option selected>Moto</option>
              <option>Passeio</option>
              <option>Fiorino</option>
              <option>Van</option>
            </select>
          </div>

          <div class="d-grid mb-3">
            <button type="button" id="add-regiao" class="btn btn-primary">
              <i class="fa fa-plus"></i> Adicionar Região (CEP + Bairro + Cidade)
            </button>
          </div>

          <div id="lista-regioes" class="mb-3"></div>
          <small class="small-dim d-block mb-3">Máximo de 20 entradas. Pode repetir o mesmo bairro com CEP diferente.</small>

          <input type="hidden" id="regioes-consolidadas">
          <input type="hidden" id="ceps-consolidados">
          <input type="hidden" id="cidades-consolidadas">

          <div class="d-grid">
            <button type="submit" class="btn btn-success">
              <i class="fa fa-paper-plane"></i> Enviar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const whoami = document.getElementById("whoami");
const idInput = document.getElementById("id");
const nomeInput = document.getElementById("nome");
const cepInput = document.getElementById("cep");
const regiaoInput = document.getElementById("regiao");
const cidadeAtual = document.getElementById("cidadeAtual");
const veiculoSelect = document.getElementById("veiculo");
const addButton = document.getElementById("add-regiao");
const lista = document.getElementById("lista-regioes");
const form = document.getElementById("form-regioes");
const cepsConsolidados = document.getElementById("ceps-consolidados");
const regioesConsolidadas = document.getElementById("regioes-consolidadas");
const cidadesConsolidadas = document.getElementById("cidades-consolidadas");
const btnLogout = document.getElementById("logout");

let itens = [], currentUser = null, existingRow = null, isLoggingOut = false;

// === CEP -> Bairro ===
cepInput.addEventListener("input", () => {
  const cep = cepInput.value.replace(/\D/g, "");
  if (cep.length === 8) {
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(r => r.json())
      .then(d => regiaoInput.value = d?.bairro || "Não encontrado")
      .catch(() => regiaoInput.value = "Erro ao buscar");
  } else regiaoInput.value = "";
});

// === Lista ===
function renderLista(){
  lista.innerHTML = "";
  itens.forEach((it,i)=>{
    const s = document.createElement("span");
    s.className="badge-region";
    s.innerHTML=`${it.bairro} (${it.cep} • ${it.cidade}) <i class='fa fa-times' onclick='remover(${i})'></i>`;
    lista.appendChild(s);
  });
}
window.remover=(i)=>{itens.splice(i,1);renderLista();updateHidden();};
function updateHidden(){
  cepsConsolidados.value = itens.map(x=>x.cep).join(",");
  regioesConsolidadas.value = itens.map(x=>x.bairro).join(",");
  cidadesConsolidadas.value = itens.map(x=>x.cidade).join(",");
}

// === Adicionar Região ===
addButton.addEventListener("click",()=>{
  const cep=cepInput.value.trim(), bairro=regiaoInput.value.trim().toUpperCase(), cidade=cidadeAtual.value.trim();
  if(!cep||cep.length!==8)return alert("CEP inválido!");
  if(!bairro)return alert("Busque o CEP para capturar o bairro.");
  if(itens.some(x=>x.cep===cep&&x.bairro===bairro))return;
  if(itens.length>=20)return alert("Máximo de 20 entradas.");
  itens.push({cep,bairro,cidade});renderLista();updateHidden();
  cepInput.value="";regiaoInput.value="";
});

// === Logout ===
btnLogout.onclick = async ()=>{
  if(isLoggingOut)return;
  isLoggingOut=true;
  try{await supabase.auth.signOut();}catch(_){}
  window.location.replace("index.html");
};

// === Sessão ===
supabase.auth.onAuthStateChange(async(_evt,session)=>{
  if(!session?.user&&!isLoggingOut)return window.location.replace("index.html");
  if(session?.user){currentUser=session.user;whoami.textContent=currentUser.email;await carregar();}
});

(async()=>{
  const {data:{user}}=await supabase.auth.getUser();
  if(!user)return window.location.replace("index.html");
  currentUser=user;whoami.textContent=user.email;await carregar();
})();

// === Carregar ===
async function carregar(){
  existingRow=null;itens=[];renderLista();updateHidden();idInput.disabled=false;
  const {data,error}=await supabase.from("atualizar_bairros").select("*").eq("owner",currentUser.id).maybeSingle();
  if(!error&&data){
    existingRow=data;
    idInput.value=data.driver_id||"";idInput.disabled=true;
    nomeInput.value=data.nome||"";veiculoSelect.value=data.veiculo||"Moto";
    const ceps=(data.ceps||"").split(",").filter(Boolean);
    const bairros=(data.regioes||"").split(",").filter(Boolean);
    const cidades=(data.cidades||"").split(",").filter(Boolean);
    for(let i=0;i<ceps.length;i++)itens.push({cep:ceps[i],bairro:bairros[i],cidade:cidades[i]||"Guarulhos"});
    renderLista();updateHidden();
  }
}

// === Enviar ===
form.addEventListener("submit",async(e)=>{
  e.preventDefault();
  try{
    if(itens.length<1)return alert("Adicione pelo menos 1 região.");
    const driver_id=idInput.value.trim();
    if(!driver_id)return alert("Informe seu ID.");

    const payload={
      owner:currentUser.id,
      email:currentUser.email,
      driver_id,
      nome:nomeInput.value.trim(),
      ceps:cepsConsolidados.value,
      regioes:regioesConsolidadas.value,
      cidades:cidadesConsolidadas.value,
      veiculo:veiculoSelect.value,
      updated_at:new Date().toISOString()
    };

    const {error:upErr}=await supabase.from("atualizar_bairros").upsert(payload,{onConflict:"owner"});
    if(upErr)throw upErr;
    await supabase.from("atualizar_bairros_log").insert({...payload,created_at:payload.updated_at});
    alert("✅ Dados salvos com sucesso!");
    await carregar();
  }catch(err){
    console.error("Erro Supabase:",err);
    alert("Erro ao salvar: "+(err?.message||JSON.stringify(err)));
  }
});
</script>
</body>
</html>
