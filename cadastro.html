<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cadastro de Regiões • OwnFleet</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
:root{
  --brand:#ee4d2d;--brand-2:#ff6b3d;--ink:#1f2937;
  --card:rgba(255,255,255,.92);--radius:20px;--shadow:0 18px 48px rgba(238,77,45,.25);
}
html,body{min-height:100%;background:linear-gradient(135deg,var(--brand),var(--brand-2));font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;color:var(--ink);}
h2{color:#fff;text-align:center;font-weight:900;margin:30px 0 20px;text-shadow:0 3px 8px rgba(0,0,0,.25);}
.card{background:var(--card);backdrop-filter:blur(8px);border-radius:var(--radius);border:1px solid rgba(255,255,255,.5);box-shadow:var(--shadow);padding:24px;margin:auto;max-width:980px;}
.badge-region{background:var(--brand);color:#fff;padding:.55rem .95rem;border-radius:999px;display:inline-flex;align-items:center;gap:.6rem;font-weight:700;margin:.3rem .3rem 0 0;}
.badge-region i{cursor:pointer}
.sticky-submit{position:sticky;bottom:0;padding-top:.6rem;background:linear-gradient(180deg,rgba(255,255,255,0)0%,#fff 40%);}
.small-dim{font-size:.9rem;color:#6b7280}
</style>
</head>
<body>
<h2>Cadastro de Regiões • OwnFleet</h2>
<div class="card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small-dim">Logado: <b id="whoami">-</b></div>
    <div class="d-flex gap-2">
      <button id="refresh" class="btn btn-sm btn-outline-secondary"><i class="fa fa-rotate"></i></button>
      <button id="logout" class="btn btn-sm btn-outline-danger"><i class="fa fa-power-off"></i> Sair</button>
    </div>
  </div>
  <hr>
  <div class="small-dim mb-2">Preencha seu <b>ID</b>, <b>Nome</b> e adicione as regiões que atende.</div>

  <form id="form-regioes" autocomplete="off">
    <div class="row g-3">
      <div class="col-md-4"><label class="form-label">ID</label><input type="text" id="id" class="form-control" placeholder="Seu ID" required></div>
      <div class="col-md-8"><label class="form-label">Nome</label><input type="text" id="nome" class="form-control" required placeholder="Seu nome completo"></div>
      <div class="col-md-3"><label class="form-label">CEP</label><input type="text" id="cep" class="form-control" maxlength="8" placeholder="Somente números"></div>
      <div class="col-md-3"><label class="form-label">Região / Bairro</label><input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar"></div>
      <div class="col-md-3"><label class="form-label">Cidade</label><select id="cidadeAtual" class="form-select"><option selected>Guarulhos</option><option>São Paulo</option><option>Mairiporã</option><option>Outros</option></select></div>
      <div class="col-md-3"><label class="form-label">Veículo</label><select id="veiculo" class="form-select"><option selected>Moto</option><option>Passeio</option><option>Fiorino</option><option>Van</option></select></div>
      <div class="col-md-12 d-grid"><button type="button" class="btn btn-primary" id="add-regiao"><i class="fa fa-plus"></i> Adicionar Região</button></div>
      <div class="col-12"><div id="lista-regioes"></div><small class="small-dim">Máximo de 20 entradas.</small></div>
      <input type="hidden" id="regioes-consolidadas"><input type="hidden" id="ceps-consolidados"><input type="hidden" id="cidades-consolidadas">
      <div class="col-12 sticky-submit"><button type="submit" class="btn btn-success w-100"><i class="fa fa-paper-plane"></i> Enviar</button></div>
    </div>
  </form>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL="https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";
const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
let currentUser=null,itens=[],existingRow=null;

function baseUrl(){const {origin,pathname}=location;const dir=pathname.endsWith("/")?pathname:pathname.replace(/[^/]*$/,"");return origin+dir;}

const whoami=document.getElementById("whoami"),btnLogout=document.getElementById("logout"),btnRefresh=document.getElementById("refresh"),
idInput=document.getElementById("id"),nomeInput=document.getElementById("nome"),cepInput=document.getElementById("cep"),
regiaoInput=document.getElementById("regiao"),cidadeAtual=document.getElementById("cidadeAtual"),
veiculoSelect=document.getElementById("veiculo"),addButton=document.getElementById("add-regiao"),
lista=document.getElementById("lista-regioes"),form=document.getElementById("form-regioes"),
cepsConsolidados=document.getElementById("ceps-consolidados"),regioesConsolidadas=document.getElementById("regioes-consolidadas"),
cidadesConsolidadas=document.getElementById("cidades-consolidadas");

cepInput.addEventListener("input",()=>{const cep=(cepInput.value||"").replace(/\D/g,"");if(cep.length===8){fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r=>r.json()).then(d=>regiaoInput.value=d?.bairro||"Não encontrado").catch(()=>regiaoInput.value="Erro ao buscar");}else regiaoInput.value="";});

function renderLista(){lista.innerHTML="";itens.forEach((it,i)=>{const s=document.createElement("span");s.className="badge-region";s.innerHTML=`${it.bairro} <small>(${it.cep} • ${it.cidade})</small> <i class="fa fa-times" onclick="remover(${i})"></i>`;lista.appendChild(s);});}
function updateHidden(){cepsConsolidados.value=itens.map(x=>x.cep).join(",");regioesConsolidadas.value=itens.map(x=>x.bairro).join(",");cidadesConsolidadas.value=itens.map(x=>x.cidade).join(",");}
window.remover=idx=>{itens.splice(idx,1);renderLista();updateHidden();};

addButton.onclick=()=>{const cep=cepInput.value.trim(),bairro=regiaoInput.value.trim().toUpperCase(),cidade=cidadeAtual.value.trim();
if(!cep||cep.length!==8)return alert("Digite um CEP válido.");
if(!bairro)return alert("Busque o CEP para capturar o bairro.");
if(itens.some(x=>x.cep===cep&&x.bairro===bairro))return;
if(itens.length>=20)return alert("Máximo de 20 entradas.");
itens.push({cep,bairro,cidade});renderLista();updateHidden();cepInput.value="";regiaoInput.value="";};

btnLogout.onclick=async()=>{await supabase.auth.signOut();window.location.replace(baseUrl()+"index.html");};
btnRefresh.onclick=()=>carregarDoOwner();

supabase.auth.onAuthStateChange(async(_,session)=>{
  if(!session?.user){window.location.replace(baseUrl()+"index.html");return;}
  currentUser=session.user;whoami.textContent=currentUser.email;await carregarDoOwner();
});

(async()=>{
  const { data:{ session } }=await supabase.auth.getSession();
  if(!session){window.location.replace(baseUrl()+"index.html");return;}
  currentUser=session.user;whoami.textContent=currentUser.email;await carregarDoOwner();
})();

async function carregarDoOwner(){
  existingRow=null;itens=[];renderLista();updateHidden();idInput.disabled=false;
  const { data,error }=await supabase.from("atualizar_bairros").select("*").eq("owner",currentUser.id).maybeSingle();
  if(!error&&data){existingRow=data;idInput.value=data.driver_id||"";idInput.disabled=true;nomeInput.value=data.nome||"";veiculoSelect.value=data.veiculo||"Moto";
  const ceps=(data.ceps||"").split(",").filter(Boolean),regioes=(data.regioes||"").split(",").filter(Boolean),cidades=(data.cidades||"").split(",").filter(Boolean);
  for(let i=0;i<ceps.length;i++)itens.push({cep:ceps[i],bairro:regioes[i],cidade:cidades[i]||"Guarulhos"});renderLista();updateHidden();}
}

form.onsubmit=async e=>{
  e.preventDefault();
  if(itens.length<1)return alert("Adicione pelo menos 1 entrada.");
  const payload={owner:currentUser.id,email:currentUser.email,driver_id:idInput.value.trim(),nome:nomeInput.value.trim(),
  ceps:cepsConsolidados.value,regioes:regioesConsolidadas.value,cidades:cidadesConsolidadas.value,veiculo:veiculoSelect.value,updated_at:new Date().toISOString()};
  const { error:upErr }=await supabase.from("atualizar_bairros").upsert(payload,{onConflict:"owner"});
  if(upErr)return alert("Erro ao salvar: "+upErr.message);
  await supabase.from("atualizar_bairros_log").insert({...payload,created_at:payload.updated_at});
  alert("✅ Dados salvos com sucesso!");await carregarDoOwner();
};
</script>
</body>
</html>
