<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel ‚Ä¢ OwnFleet</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root{
  --brand:#ee4d2d; --brand2:#ff6b3d; --ink:#0f172a;
  --card:rgba(255,255,255,.94); --radius:18px; --shadow:0 20px 50px rgba(238,77,45,.22);
  --line:#eef2f7; --muted:#6b7280; --ok:#10b981; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Poppins,system-ui,Arial;color:var(--ink);
  background:
    radial-gradient(1200px 600px at 85% -10%, #ffd5cc 0, transparent 60%),
    radial-gradient(1200px 600px at -10% 90%, #ffc6b7 0, transparent 55%),
    linear-gradient(135deg,var(--brand),var(--brand2));
  min-height:100vh;
}
.container{max-width:1160px;margin:34px auto;padding:0 18px;animation:fadeIn .35s ease-out}
.card{
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
  backdrop-filter: blur(6px);
}
.header{
  display:flex;align-items:center;justify-content:space-between;padding:18px;gap:12px;
  background:linear-gradient(180deg,#fff7f5,rgba(255,255,255,.85));
  border-bottom:1px solid var(--line);
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(145deg,#fff,#fff7f5);
  display:grid;place-items:center;
  box-shadow:0 10px 30px rgba(238,77,45,.25);
  transform:translateZ(0);
}
.logo i{color:var(--brand);font-size:22px}
.title h1{margin:0;font-size:1.35rem;color:var(--brand);font-weight:900}
.subtitle{margin:2px 0 0;color:#475569;font-size:.9rem}

/* toolbar */
.toolbar{padding:0 18px 18px 18px}
textarea{
  width:100%;min-height:56px;padding:12px 14px;border-radius:12px;border:1px solid #e6e6e6;resize:vertical;
  transition:border .2s, box-shadow .2s;
}
textarea:focus{outline:none;border-color:#ffb199;box-shadow:0 0 0 4px rgba(238,77,45,.12)}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;align-items:center}
.btn{
  border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:.6rem;
  transition:transform .15s ease, box-shadow .15s ease, opacity .2s;
}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-primary{background:var(--brand)}
.btn-green{background:var(--ok)}
.btn-blue{background:#0ea5e9}
.btn-gray{background:#6b7280}
.btn:disabled{opacity:.6;cursor:not-allowed}

/* table */
.table-wrap{overflow:auto;border-top:1px solid #f3f4f6}
table{width:100%;border-collapse:collapse;background:#fff}
thead th{
  position:sticky;top:0;background:#fff7f5;padding:12px 14px;text-align:left;border-bottom:1px solid #f1f5f9;
  font-weight:800;color:#263043;
}
tbody td{padding:12px 14px;border-bottom:1px solid #f6f7fb;font-size:.95rem;vertical-align:top}
tbody tr{
  animation:rowIn .25s ease both;
}
tbody tr:hover{background:#fffaf8}
.empty{padding:28px;text-align:center;color:#64748b}

/* col widths + ellipsis */
.clip{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.col-id .clip{max-width:120px}
.col-nome .clip{max-width:240px}
.col-ceps .clip{max-width:420px}
.col-regioes .clip{max-width:380px}
.col-cidades .clip{max-width:260px}
.col-veiculo .clip{max-width:120px}
.col-acoes{width:130px}

/* actions buttons */
.row-actions{display:flex;gap:8px;align-items:center}
.icon-btn{
  border:0;background:#f6f7fb;color:#334155;border-radius:10px;padding:8px 10px;cursor:pointer;
  display:inline-flex;align-items:center;gap:.45rem;font-weight:700;
  transition:transform .12s ease, background .15s ease, color .15s ease, box-shadow .15s ease;
  box-shadow:0 2px 0 rgba(15,23,42,.05);
}
.icon-btn:hover{transform:translateY(-1px);background:#eef1f9;box-shadow:0 4px 10px rgba(15,23,42,.08)}
.icon-btn:active{transform:translateY(0)}
.icon-copy{color:#0ea5e9}
.icon-expand{color:#f97316}

/* modal */
.backdrop{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);z-index:100}
.modal{width:min(94vw,420px);background:#fff;border-radius:16px;padding:18px;box-shadow:0 26px 60px rgba(0,0,0,.25)}
.modal h2{margin:0 0 6px;font-size:1.2rem}
.modal p{margin:0 0 12px;color:#475569}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6e6}
.msg{margin-top:8px;color:#b00020;font-size:.95rem}

/* small */
.kbd{background:#eef2ff;border-radius:6px;padding:4px 8px;font-weight:700;color:#0f172a;font-size:.82rem}

/* toast */
.toast{
  position:fixed;right:18px;bottom:18px;background:rgba(255,255,255,.98);padding:10px 14px;border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);display:none;font-weight:800;color:#0f172a
}
.toast.show{display:block;animation:pop .2s ease}

/* animations */
@keyframes fadeIn {from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
@keyframes rowIn {from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)}}
@keyframes pop {from{transform:scale(.98);opacity:.8} to{transform:scale(1);opacity:1}}

@media (max-width:640px){
  .header{flex-direction:column;align-items:flex-start;gap:8px}
  .col-ceps .clip{max-width:220px}
  .col-regioes .clip{max-width:220px}
  .col-cidades .clip{max-width:180px}
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="header">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-map-location-dot"></i></div>
        <div class="title">
          <h1>OwnFleet ‚Ä¢ Painel</h1>
          <div class="subtitle">Motoristas cadastrados e suas regi√µes</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnLoadAll" class="btn btn-primary"><i class="fa-solid fa-database"></i> Carregar</button>
        <button id="btnExport" class="btn btn-green"><i class="fa-solid fa-file-export"></i> Exportar</button>
      </div>
    </div>

    <div class="toolbar">
      <textarea id="idsBulk" placeholder="IDs separados por v√≠rgula, espa√ßo ou quebra de linha ‚Äî use para exportar/exibir apenas esses IDs quando quiser."></textarea>

      <div class="controls">
        <button id="btnSearch" class="btn btn-blue"><i class="fa-solid fa-search"></i> Buscar</button>
        <button id="btnClear" class="btn btn-gray"><i class="fa-solid fa-eraser"></i> Limpar</button>
        <div style="margin-left:auto;color:#475569;font-weight:700">Total: <span id="count">0</span></div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="table">
        <thead>
          <tr>
            <th class="col-id" style="width:140px">ID</th>
            <th class="col-nome" style="width:220px">Nome</th>
            <th class="col-ceps" style="width:200px">CEP(s)</th>
            <th class="col-regioes" style="width:280px">Regi√£o/Bairro(s)</th>
            <th class="col-cidades" style="width:200px">Cidade(s)</th>
            <th class="col-veiculo" style="width:140px">Ve√≠culo</th>
            <th class="col-acoes">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr class="empty"><td colspan="7">Sem dados. Insira a senha para liberar o painel.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- admin gate -->
<div class="backdrop" id="gate">
  <div class="modal">
    <h2><i class="fa-solid fa-lock"></i> Acesso Administrativo</h2>
    <p>Digite a senha para visualizar o painel completo.</p>
    <input id="adminPass" type="password" class="input" placeholder="Senha admin" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnEnter" class="btn btn-primary"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
    </div>
    <div id="gateMsg" class="msg"></div>
    <p style="margin-top:12px;color:#475569;font-size:.88rem">
      A senha √© verificada via <span class="kbd">SHA-256</span> comparando com o hash salvo na tabela <b>painel_admin</b>.
    </p>
  </div>
</div>

<div id="toast" class="toast"><i class="fa-solid fa-circle-check" style="color:#16a34a;margin-right:8px"></i><span id="toastMsg">OK</span></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* === CONFIG SUPABASE === */
const SUPABASE_URL = "https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* === ELEMENTOS === */
const tbody     = document.getElementById("tbody");
const countEl   = document.getElementById("count");
const idsBulk   = document.getElementById("idsBulk");
const btnSearch = document.getElementById("btnSearch");
const btnClear  = document.getElementById("btnClear");
const btnLoadAll= document.getElementById("btnLoadAll");
const btnExport = document.getElementById("btnExport");

const gate      = document.getElementById("gate");
const adminPass = document.getElementById("adminPass");
const btnEnter  = document.getElementById("btnEnter");
const gateMsg   = document.getElementById("gateMsg");

const toast     = document.getElementById("toast");
const toastMsg  = document.getElementById("toastMsg");

let allRows = [];
let currentRows = []; // üîπ o que est√° exibido agora (para exportar/copiar)

/* === UTIL === */
function showToast(txt){
  toastMsg.textContent = txt;
  toast.classList.add("show");
  setTimeout(()=> toast.classList.remove("show"), 1400);
}
function setLoading(btn, on){
  if(on){ btn.dataset.html = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Aguarde‚Ä¶'; }
  else { btn.disabled = false; if(btn.dataset.html) btn.innerHTML = btn.dataset.html; }
}

/* ‚Äî‚Äî MOSTRAR VISUAL ENXUTO SEM PERDER O DADO COMPLETO ‚Äî‚Äî */
function summarizeCSV(str, maxItems = 3, maxChars = 120){
  if(!str) return {preview:"", full:""};
  const full = String(str);
  const arr = full.split(",").map(s => s.trim()).filter(Boolean);
  const head = arr.slice(0, maxItems).join(", ");
  const extra = arr.length - maxItems;
  let preview = head + (extra > 0 ? ` ‚Ä¶ (+${extra})` : "");
  if(preview.length > maxChars) preview = preview.slice(0, maxChars - 1) + "‚Ä¶";
  return { preview, full };
}

/* === CSV de 1 linha (sem cabe√ßalho) === */
function rowToCsvLine(r){
  const vals = [
    r.driver_id ?? "",
    r.nome ?? "",
    r.ceps ?? "",
    r.regioes ?? "",
    r.cidades ?? "",
    r.veiculo ?? ""
  ].map(v => `"${String(v).replace(/"/g,'""')}"`);
  return vals.join(",");
}

/* Copiar dados de 1 motorista (somente informa√ß√µes) */
async function copyRow(r){
  try{
    const csvLine = rowToCsvLine(r);        // apenas a linha
    await navigator.clipboard.writeText(csvLine);
    showToast("Copiado!");
  }catch(e){
    console.error(e);
    showToast("Falha ao copiar");
  }
}

/* Render da tabela */
function render(rows){
  const data = Array.isArray(rows) ? rows : [];
  currentRows = data; // üîπ atualiza conjunto exibido
  countEl.textContent = data.length;
  tbody.innerHTML = "";
  if(!data.length){
    const tr = document.createElement("tr");
    tr.className = "empty";
    tr.innerHTML = `<td colspan="7">Nenhum registro encontrado.</td>`;
    tbody.appendChild(tr);
    return;
  }
  for(const r of data){
    const ceps    = summarizeCSV(r.ceps, 3, 140);
    const regioes = summarizeCSV(r.regioes, 2, 120);
    const cidades = summarizeCSV(r.cidades, 2, 100);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-id"><span class="clip" title="${r.driver_id ?? ""}">${r.driver_id ?? ""}</span></td>
      <td class="col-nome"><span class="clip" title="${r.nome ?? ""}">${r.nome ?? ""}</span></td>
      <td class="col-ceps"><span class="clip" title="${ceps.full}">${ceps.preview}</span></td>
      <td class="col-regioes"><span class="clip" title="${regioes.full}">${regioes.preview}</span></td>
      <td class="col-cidades"><span class="clip" title="${cidades.full}">${cidades.preview}</span></td>
      <td class="col-veiculo"><span class="clip" title="${r.veiculo ?? ""}">${r.veiculo ?? ""}</span></td>
      <td class="col-acoes">
        <div class="row-actions">
          <button class="icon-btn icon-copy" title="Copiar dados">
            <i class="fa-regular fa-clipboard"></i><span>Copiar</span>
          </button>
          <button class="icon-btn icon-expand" title="Ver completo">
            <i class="fa-solid fa-up-right-and-down-left-from-center"></i><span>Ver</span>
          </button>
        </div>
      </td>`;
    const [btnCopy, btnView] = tr.querySelectorAll(".icon-btn");
    btnCopy.addEventListener("click", () => copyRow(r));
    btnView.addEventListener("click", () => {
      const txt = [
        `ID: ${r.driver_id ?? ""}`,
        `Nome: ${r.nome ?? ""}`,
        `CEP(s): ${r.ceps ?? ""}`,
        `Regi√£o(s): ${r.regioes ?? ""}`,
        `Cidade(s): ${r.cidades ?? ""}`,
        `Ve√≠culo: ${r.veiculo ?? ""}`
      ].join("\n");
      navigator.clipboard.writeText(txt).then(()=>showToast("Detalhes copiados")).catch(()=>showToast("Falha ao copiar"));
    });
    tbody.appendChild(tr);
  }
}

/* SHA-256 util */
async function sha256(message){
  const enc = new TextEncoder().encode(message);
  const hash = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

/* === ADMIN GATE === */
btnEnter.onclick = async () => {
  const s = (adminPass.value || "").trim();
  gateMsg.textContent = "";
  if(!s){ gateMsg.textContent = "Digite a senha."; return; }

  gateMsg.textContent = "Verificando‚Ä¶";

  try{
    const hash = await sha256(s);

    const { data, error } = await supabase
      .from("painel_admin")
      .select("senha_hash")
      .maybeSingle();

    if(error || !data){ gateMsg.textContent = "Erro ao verificar (verifique painel_admin)."; return; }

    if(hash === String(data.senha_hash).toLowerCase()){
      gate.style.display = "none";
      showToast("Acesso liberado ‚Äî carregando dados...");
      await loadAll();
    } else {
      gateMsg.textContent = "Senha incorreta.";
    }
  } catch(e){
    console.error(e);
    gateMsg.textContent = "Falha na verifica√ß√£o.";
  }
};

/* === CARREGAR TABELA (RPC + FALLBACK) === */
async function loadAll(){
  setLoading(btnLoadAll, true);
  try{
    // 1) Tenta via RPC (funciona melhor com RLS)
    const rpc = await supabase.rpc("listar_atualizar_bairros");
    if(Array.isArray(rpc.data) && rpc.data.length){
      allRows = rpc.data || [];
      render(allRows);
      showToast("Dados carregados");
      return;
    }

    // 2) Fallback: SELECT direto
    const { data, error } = await supabase
      .from("atualizar_bairros")
      .select("driver_id, nome, ceps, regioes, cidades, veiculo")
      .order("nome", { ascending: true })
      .limit(5000);
    if(error) throw error;
    allRows = data || [];
    render(allRows);
    showToast("Dados carregados");
  } catch(e){
    alert("Erro ao carregar: " + (e.message || e));
    console.error(e);
  } finally {
    setLoading(btnLoadAll, false);
  }
}
btnLoadAll.onclick = loadAll;

/* === BUSCAR POR IDS (usa base carregada) === */
btnSearch.onclick = async () => {
  const ids = idsBulk.value.split(/[\s,;,]+/).map(s=>s.trim()).filter(Boolean);
  if(!ids.length){ alert("Informe ao menos um ID."); return; }
  setLoading(btnSearch, true);
  try{
    let base = allRows.length ? allRows : [];
    if(!base.length){
      const rpc = await supabase.rpc("listar_atualizar_bairros");
      base = Array.isArray(rpc.data) && rpc.data.length ? rpc.data : [];
      if(!base.length){
        const sel = await supabase
          .from("atualizar_bairros")
          .select("driver_id, nome, ceps, regioes, cidades, veiculo")
          .in("driver_id", ids);
        if(sel.error) throw sel.error;
        base = sel.data || [];
      }
    }
    const set = new Set(ids.map(String));
    const filtrados = base.filter(r => set.has(String(r.driver_id)));
    render(filtrados); // üîπ agora currentRows = filtrados
    showToast("Busca conclu√≠da");
  } catch(e){
    alert("Erro na busca: " + (e.message || e));
  } finally {
    setLoading(btnSearch, false);
  }
};

/* === LIMPAR === */
btnClear.onclick = () => {
  idsBulk.value = "";
  render([]); // üîπ limpa currentRows
};

/* === EXPORTAR CSV do que est√° FILTRADO/EXIBIDO === */
btnExport.onclick = () => {
  if(!currentRows.length){ alert("Nada para exportar."); return; }

  const header = ["driver_id","nome","ceps","regioes","cidades","veiculo"];
  const csv = [
    header.join(","),
    ...currentRows.map(r => {
      // apenas dados, com aspas e escape
      const vals = [r.driver_id??"", r.nome??"", r.ceps??"", r.regioes??"", r.cidades??"", r.veiculo??""]
        .map(v => `"${String(v).replace(/"/g,'""')}"`);
      return vals.join(",");
    })
  ].join("\n");

  // BOM garante que Excel entenda UTF-8 e n√£o quebre acentos
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download = `motoristas_${stamp}.csv`;
  a.click();
  showToast("CSV exportado (linhas exibidas)");
};
</script>
</body>
</html>
