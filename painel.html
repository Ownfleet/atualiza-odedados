<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel ‚Ä¢ OwnFleet</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
:root{
  --brand:#ee4d2d; --brand-2:#ff6b3d; --ink:#111827;
  --card:rgba(255,255,255,.95); --shadow:0 18px 48px rgba(238,77,45,.25);
  --radius:18px;
}
body{margin:0;background:linear-gradient(145deg,var(--brand),var(--brand-2));
font-family:Poppins,system-ui,Arial;color:var(--ink);}
.container{max-width:1100px;margin:30px auto;padding:0 16px;}
.card{background:var(--card);backdrop-filter:blur(12px);border-radius:var(--radius);
box-shadow:var(--shadow);padding:18px;}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(145deg,#fff6f4,#fff);
display:grid;place-items:center;box-shadow:0 6px 18px rgba(238,77,45,.25)}
.brand .logo i{color:var(--brand);font-size:22px}
.brand h1{margin:0;font-size:1.35rem;color:var(--brand);font-weight:900}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;color:#fff;background:var(--brand);
cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:.5rem}
.btn.green{background:#10b981}
.btn.secondary{background:#0ea5e9}
.btn.gray{background:#6b7280}
.btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
.table-wrap{overflow:auto;border-radius:14px;margin-top:12px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;font-size:.92rem}
th{background:#fff7f5;text-align:left}
tbody tr:hover{background:#fff9f7}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;z-index:50}
.modal{width:94%;max-width:380px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 18px 48px rgba(0,0,0,.2)}
.modal h2{margin:0 0 6px 0;color:#111;font-size:1.2rem}
.modal p{margin:0 0 12px 0;color:#374151}
.small{color:#6b7280;font-size:.85rem}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-map-location-dot"></i></div>
        <div>
          <h1>OwnFleet ‚Ä¢ Painel</h1>
          <div class="small">Motoristas cadastrados e suas regi√µes</div>
        </div>
      </div>
      <div>
        <button id="btnLoadAll" class="btn"><i class="fa fa-database"></i> Carregar</button>
        <button id="btnExport" class="btn green"><i class="fa fa-file-export"></i> Exportar</button>
      </div>
    </div>

    <textarea id="idsBulk" placeholder="IDs separados por v√≠rgula ou espa√ßo" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;"></textarea>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <button id="btnSearch" class="btn secondary"><i class="fa fa-search"></i> Buscar</button>
      <button id="btnClear" class="btn gray"><i class="fa fa-eraser"></i> Limpar</button>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead><tr>
          <th>ID</th><th>Nome</th><th>CEP(s)</th>
          <th>Regi√£o/Bairro(s)</th><th>Cidade(s)</th><th>Ve√≠culo</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- modal senha -->
<div class="modal-backdrop" id="adminGate">
  <div class="modal">
    <h2><i class="fa fa-lock"></i> Acesso Administrativo</h2>
    <p>Digite a senha para continuar.</p>
    <input id="adminPass" type="password" placeholder="Senha admin" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnEnter" class="btn"><i class="fa fa-door-open"></i> Entrar</button>
    </div>
    <div id="gateMsg" class="small" style="color:#b00020;margin-top:8px"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL="https://bzbkqvxixxkcmfrhtcxq.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const adminGate=document.getElementById("adminGate");
const adminPass=document.getElementById("adminPass");
const gateMsg=document.getElementById("gateMsg");
const btnEnter=document.getElementById("btnEnter");

const tbody=document.getElementById("tbody");
const btnSearch=document.getElementById("btnSearch");
const btnClear=document.getElementById("btnClear");
const btnLoadAll=document.getElementById("btnLoadAll");
const btnExport=document.getElementById("btnExport");
const idsBulk=document.getElementById("idsBulk");
let allRows=[];

// üîê Fun√ß√£o SHA-256
async function sha256(message){
  const msgBuffer=new TextEncoder().encode(message);
  const hashBuffer=await crypto.subtle.digest("SHA-256",msgBuffer);
  const hashArray=Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b=>b.toString(16).padStart(2,"0")).join("");
}

// Login admin
btnEnter.onclick=async()=>{
  const senha=(adminPass.value||"").trim();
  if(!senha)return gateMsg.textContent="Digite a senha.";
  gateMsg.textContent="Verificando...";
  const hash=await sha256(senha);

  const {data,error}=await supabase.from("painel_admin").select("senha_hash").limit(1).single();
  if(error||!data)return gateMsg.textContent="Erro ao verificar.";
  if(hash===data.senha_hash){
    adminGate.style.display="none";
  }else{
    gateMsg.textContent="Senha incorreta.";
  }
};

// Buscar motoristas
function render(rows){
  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.driver_id||""}</td>
    <td>${r.nome||""}</td><td>${r.ceps||""}</td>
    <td>${r.regioes||""}</td><td>${r.cidades||""}</td>
    <td>${r.veiculo||""}</td>`;
    tbody.appendChild(tr);
  });
}
btnSearch.onclick=async()=>{
  const ids=idsBulk.value.split(/[\s,;]+/).filter(Boolean);
  if(!ids.length)return alert("Informe ao menos um ID.");
  const {data,error}=await supabase.from("atualizar_bairros").select("*").in("driver_id",ids);
  if(error)return alert("Erro: "+error.message);
  allRows=data||[];render(allRows);
};
btnLoadAll.onclick=async()=>{
  const {data,error}=await supabase.from("atualizar_bairros").select("*").limit(1000);
  if(error)return alert("Erro: "+error.message);
  allRows=data||[];render(allRows);
};
btnClear.onclick=()=>{idsBulk.value="";tbody.innerHTML="";};

// exportar CSV
btnExport.onclick=()=>{
  if(!allRows.length)return alert("Nada para exportar.");
  const csv=allRows.map(r=>[r.driver_id,r.nome,r.ceps,r.regioes,r.cidades,r.veiculo].map(v=>`"${v||""}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="motoristas.csv";
  a.click();
};
</script>
</body>
</html>
