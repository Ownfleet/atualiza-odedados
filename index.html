<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Regiões • Shopee</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
:root{
  --brand:#ee4d2d; --brand-2:#ff6b3d; --ink:#1f2937;
  --card:rgba(255,255,255,.92); --radius:20px;
  --shadow:0 18px 48px rgba(238,77,45,.25);
}
html,body{
  min-height:100%;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
  color:var(--ink);
}
h2{
  color:#fff; text-align:center; font-weight:900; margin:30px 0 20px;
  text-shadow:0 3px 8px rgba(0,0,0,.25);
}
.card{
  background:var(--card); backdrop-filter:blur(8px);
  border-radius:var(--radius); border:1px solid rgba(255,255,255,.5);
  box-shadow:var(--shadow); padding:24px; margin:auto; max-width:980px;
}
.badge-region{
  background:var(--brand);color:#fff;padding:.55rem .95rem;border-radius:999px;
  display:inline-flex;align-items:center;gap:.6rem;font-weight:700;margin:.3rem .3rem 0 0;
}
.badge-region i{ cursor:pointer; }
.sticky-submit{
  position:sticky;bottom:0;padding-top:.6rem;
  background:linear-gradient(180deg,rgba(255,255,255,0)0%,#fff 40%);
}
.small-dim{ font-size:.9rem; color:#6b7280; }
</style>
</head>
<body>
  <h2>Cadastro de Regiões • Shopee</h2>

  <div id="main-card" class="card">
    <div class="small-dim mb-2">
      Preencha seu <b>ID</b>, <b>Nome</b> e adicione as regiões que atende. Depois clique em <b>Enviar</b>.
    </div>

    <form id="form-regioes" autocomplete="off">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">ID</label>
          <input type="text" id="id" class="form-control" placeholder="Seu ID" required>
          <div class="small-dim mt-1">Ao digitar o ID e sair do campo, buscamos seus dados salvos (se houver).</div>
        </div>
        <div class="col-md-8">
          <label class="form-label">Nome</label>
          <input type="text" id="nome" class="form-control" required placeholder="Seu nome completo">
        </div>

        <div class="col-md-4">
          <label class="form-label">CEP</label>
          <input type="text" id="cep" class="form-control" maxlength="8" placeholder="Somente números">
        </div>
        <div class="col-md-4">
          <label class="form-label">Região / Bairro</label>
          <input type="text" id="regiao" class="form-control" readonly placeholder="Preencha o CEP para buscar">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cidade</label>
          <select id="cidadeAtual" class="form-select">
            <option selected>Guarulhos</option>
            <option>São Paulo</option>
            <option>Mairiporã</option>
            <option>Outros</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Veículo</label>
          <select id="veiculo" class="form-select">
            <option selected>Moto</option>
            <option>Passeio</option>
            <option>Fiorino</option>
            <option>Van</option>
          </select>
        </div>
        <div class="col-md-8 d-grid">
          <label class="form-label invisible">.</label>
          <button type="button" class="btn btn-primary" id="add-regiao">
            <i class="fa fa-plus"></i> Adicionar Região (CEP + Bairro + Cidade)
          </button>
        </div>

        <div class="col-12">
          <div id="lista-regioes"></div>
          <small class="small-dim">Máximo de 20 entradas. Repetir <b>mesmo bairro</b> com <b>CEP diferente</b> é permitido.</small>
        </div>

        <!-- hidden para envio -->
        <input type="hidden" id="regioes-consolidadas">
        <input type="hidden" id="ceps-consolidados">
        <input type="hidden" id="cidades-consolidadas">

        <div class="col-12 sticky-submit">
          <button type="submit" class="btn btn-success w-100">
            <i class="fa fa-paper-plane"></i> Enviar
          </button>
        </div>
      </div>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === CONFIG SUPABASE ===
    const SUPABASE_URL = "https://bzbkqvxixxkcmfrhtcxq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YmtxdnhpeHhrY21mcmh0Y3hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzI2MzUsImV4cCI6MjA3NjcwODYzNX0.TNKG7NIx7HHSTcfU2IYiba9zV0zaPYvhGSImA62LebE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === ELEMENTOS ===
    const idInput       = document.getElementById("id");
    const nomeInput     = document.getElementById("nome");
    const cepInput      = document.getElementById("cep");
    const regiaoInput   = document.getElementById("regiao");
    const cidadeAtual   = document.getElementById("cidadeAtual");
    const veiculoSelect = document.getElementById("veiculo");
    const addButton     = document.getElementById("add-regiao");
    const lista         = document.getElementById("lista-regioes");
    const form          = document.getElementById("form-regioes");
    const cepsConsolidados     = document.getElementById("ceps-consolidados");
    const regioesConsolidadas  = document.getElementById("regioes-consolidadas");
    const cidadesConsolidadas  = document.getElementById("cidades-consolidadas");

    // === ESTADO ===
    let itens = [];

    // --- utils
    const csvToArray = (csv) => csv ? csv.split(",").map(s => s.trim()).filter(Boolean) : [];
    const arrToCsv   = (arr) => (arr || []).join(",");

    // === CEP -> BAIRRO (ViaCEP)
    cepInput.addEventListener("input", () => {
      const cep = (cepInput.value || "").replace(/\D/g, "");
      if (cep.length === 8) {
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
          .then(r => r.json())
          .then(d => regiaoInput.value = d?.bairro || "Não encontrado")
          .catch(() => regiaoInput.value = "Erro ao buscar");
      } else {
        regiaoInput.value = "";
      }
    });

    // === LISTA REGIÕES
    function renderLista(){
      lista.innerHTML = "";
      itens.forEach((it, i) => {
        const s = document.createElement("span");
        s.className = "badge-region";
        s.innerHTML = `${it.bairro} <small>(${it.cep})</small> <i class="fa fa-times" title="Remover" onclick="remover(${i})"></i>`;
        lista.appendChild(s);
      });
    }
    function updateHidden(){
      cepsConsolidados.value    = arrToCsv(itens.map(x => x.cep));
      regioesConsolidadas.value = arrToCsv(itens.map(x => x.bairro));
      cidadesConsolidadas.value = arrToCsv(itens.map(x => x.cidade));
    }
    window.remover = (idx) => { itens.splice(idx,1); renderLista(); updateHidden(); };

    addButton.addEventListener("click", () => {
      const cep    = (cepInput.value || "").trim();
      const bairro = (regiaoInput.value || "").trim().toUpperCase();
      const cidade = (cidadeAtual.value || "").trim();
      if (!cep || cep.length !== 8) return alert("Digite um CEP válido (8 dígitos).");
      if (!bairro) return alert("Busque o CEP para capturar a região/bairro.");
      if (itens.some(x => x.cep === cep && x.bairro === bairro)) return;
      if (itens.length >= 20) return alert("Máximo de 20 entradas.");

      itens.push({ cep, bairro, cidade });
      renderLista(); updateHidden();
      cepInput.value = ""; regiaoInput.value = "";
    });

    // === CARREGAR cadastro ao informar ID
    async function carregarCadastro(driverId){
      if (!driverId) return;
      const { data, error } = await supabase
        .from("atualizar_bairros")
        .select("*")
        .eq("driver_id", driverId)
        .maybeSingle();

      if (error) { console.warn(error); return; }

      if (data){
        nomeInput.value = data.nome || "";
        veiculoSelect.value = data.veiculo || "Moto";

        const arrCeps    = csvToArray(data.ceps);
        const arrBairros = csvToArray(data.regioes);
        const arrCidades = csvToArray(data.cidades);

        itens = [];
        const n = Math.max(arrCeps.length, arrBairros.length, arrCidades.length);
        for (let i=0;i<n;i++){
          const cep = (arrCeps[i]||"").trim();
          const bairro = (arrBairros[i]||"").trim().toUpperCase();
          const cidade = (arrCidades[i]||"").trim() || "Guarulhos";
          if (cep && bairro) itens.push({ cep, bairro, cidade });
        }
        renderLista(); updateHidden();
      } else {
        // novo cadastro
        itens = []; renderLista(); updateHidden();
        nomeInput.value = "";
        veiculoSelect.value = "Moto";
      }
    }

    idInput.addEventListener("change", () => carregarCadastro(idInput.value.trim()));
    idInput.addEventListener("blur",   () => carregarCadastro(idInput.value.trim()));

    // se vier ?id= na URL, carrega automático
    const url = new URL(location.href);
    const qid = url.searchParams.get("id");
    if (qid){ idInput.value = qid; carregarCadastro(qid); }

    // === SUBMIT (UPSERT + LOG)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (itens.length < 1) return alert("Adicione pelo menos 1 entrada (CEP + Bairro).");

      const driver_id = (idInput.value || "").trim();
      if (!driver_id) return alert("Informe seu ID.");

      const payload = {
        driver_id,
        nome: (nomeInput.value || "").trim(),
        ceps: (cepsConsolidados.value || "").trim(),
        regioes: (regioesConsolidadas.value || "").trim(),
        cidades: (cidadesConsolidadas.value || "").trim(),
        veiculo: (veiculoSelect.value || "").trim(),
        updated_at: new Date().toISOString()
      };

      try{
        // UPSERT snapshot
        const { error: upErr } = await supabase
          .from("atualizar_bairros")
          .upsert(payload, { onConflict: "driver_id" });
        if (upErr) throw upErr;

        // LOG histórico
        const { error: logErr } = await supabase
          .from("atualizar_bairros_log")
          .insert({
            driver_id: payload.driver_id,
            nome: payload.nome,
            ceps: payload.ceps,
            regioes: payload.regioes,
            cidades: payload.cidades,
            veiculo: payload.veiculo,
            created_at: payload.updated_at
          });
        if (logErr) throw logErr;

        alert("Dados enviados com sucesso!");
      }catch(err){
        console.error(err);
        alert("Erro ao salvar: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>

